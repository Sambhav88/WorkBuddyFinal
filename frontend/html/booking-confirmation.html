<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Booking Confirmation - WorkBuddy</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/styles.css">
    <style>
        .confirmation-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 20px;
        }
        
        .page-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .page-header h1 {
            color: #2c3e50;
            margin-bottom: 1rem;
        }
        
        .status-card {
            background-color: #fff;
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .status-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
        
        .success {
            color: #2ecc71;
        }
        
        .processing {
            color: #f39c12;
        }
        
        .worker-card {
            background-color: #fff;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
            display: none;
        }
        
        .worker-card.active {
            display: block;
        }
        
        .worker-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .worker-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #3498db;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 1rem;
            font-size: 1.5rem;
        }
        
        .worker-info h3 {
            margin: 0 0 0.25rem 0;
            color: #2c3e50;
        }
        
        .worker-info p {
            margin: 0;
            color: #7f8c8d;
        }
        
        .worker-rating {
            color: #f39c12;
            font-weight: bold;
        }
        
        .worker-details {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
            margin: 1rem 0;
            padding: 1rem 0;
            border-top: 1px solid #eee;
            border-bottom: 1px solid #eee;
        }
        
        .detail-item {
            flex: 1;
            min-width: 150px;
        }
        
        .detail-label {
            font-weight: bold;
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        .detail-value {
            font-size: 1.1rem;
            color: #2c3e50;
        }
        
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 1.5rem;
        }
        
        .btn {
            padding: 12px 20px;
            border-radius: 5px;
            text-decoration: none;
            font-weight: bold;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            min-width: 120px;
        }
        
        .btn-accept {
            background-color: #2ecc71;
            color: #fff;
        }
        
        .btn-accept:hover {
            background-color: #27ae60;
        }
        
        .btn-reject {
            background-color: #e74c3c;
            color: #fff;
        }
        
        .btn-reject:hover {
            background-color: #c0392b;
        }
        
        .btn-negotiate {
            background-color: #f39c12;
            color: #fff;
        }
        
        .btn-negotiate:hover {
            background-color: #d35400;
        }
        
        .btn-primary {
            background-color: #3498db;
            color: #fff;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .processing-steps {
            display: flex;
            justify-content: space-between;
            margin: 2rem 0;
            position: relative;
        }
        
        .processing-steps::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: #ecf0f1;
            z-index: 1;
        }
        
        .step {
            text-align: center;
            position: relative;
            z-index: 2;
        }
        
        .step-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #ecf0f1;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 0.5rem;
            color: #7f8c8d;
        }
        
        .step.active .step-icon {
            background-color: #3498db;
            color: #fff;
        }
        
        .step.completed .step-icon {
            background-color: #2ecc71;
            color: #fff;
        }
        
        .step-label {
            font-size: 0.9rem;
            color: #7f8c8d;
        }
        
        .step.active .step-label {
            color: #3498db;
            font-weight: bold;
        }
        
        .step.completed .step-label {
            color: #2ecc71;
            font-weight: bold;
        }
        
        .notification {
            background-color: #e8f4fc;
            border-radius: 10px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            text-align: center;
        }
        
        .chat-container {
            background-color: #fff;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-top: 1.5rem;
            display: none;
        }
        
        .chat-container.active {
            display: block;
        }
        
        .chat-messages {
            height: 200px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 5px;
            padding: 1rem;
            margin-bottom: 1rem;
            background-color: #f8f9fa;
        }
        
        .message {
            margin-bottom: 1rem;
        }
        
        .customer-message {
            text-align: right;
        }
        
        .worker-message {
            text-align: left;
        }
        
        .message-bubble {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 10px;
            max-width: 70%;
        }
        
        .customer-bubble {
            background-color: #3498db;
            color: #fff;
        }
        
        .worker-bubble {
            background-color: #ecf0f1;
            color: #2c3e50;
        }
        
        .chat-input {
            display: flex;
            gap: 0.5rem;
        }
        
        .chat-input input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .chat-input button {
            padding: 0.75rem 1.5rem;
            background-color: #3498db;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .payment-options {
            background-color: #fff;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-top: 1.5rem;
            display: none;
        }
        
        .payment-options.active {
            display: block;
        }
        
        .payment-methods {
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
            margin: 1.5rem 0;
        }
        
        .payment-method {
            border: 2px solid #eee;
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            width: 150px;
        }
        
        .payment-method:hover, .payment-method.selected {
            border-color: #3498db;
            background-color: #e8f4fc;
        }
        
        .payment-method i {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: #3498db;
        }
        
        .masked-contact {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
            text-align: center;
        }
        
        .masked-number {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2c3e50;
            letter-spacing: 2px;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>WorkBuddy</h1>
            <nav>
                <ul>
                    <li><a href="home.html">Home</a></li>
                    <li><a href="customer-dashboard.html">Dashboard</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <section class="confirmation-hero">
        <div class="container confirmation-hero-content">
            <h1>Booking Confirmed!</h1>
            <p>Your service request has been successfully submitted</p>
        </div>
    </section>

    <main>
        <div class="container">
            <div class="confirmation-container">
                <div class="confirmation-card">
                    <div class="confirmation-icon" style="background-image: url('../images/subcategories/electrician.svg');"></div>
                    <h2>Thank You for Your Booking!</h2>
                    <p>We've received your service request and will connect you with a professional shortly.</p>
                    
                    <div class="booking-details">
                        <h3>Booking Details</h3>
                        <div class="detail-item">
                            <div class="detail-label">Service:</div>
                            <div class="detail-value">Electrician Service</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Date:</div>
                            <div class="detail-value">Oct 15, 2025</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Time:</div>
                            <div class="detail-value">10:00 AM - 12:00 PM</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Location:</div>
                            <div class="detail-value">123 Main St, Mumbai</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Booking ID:</div>
                            <div class="detail-value">#WB20251015001</div>
                        </div>
                    </div>
                    
                    <div class="worker-info">
                        <h3>Assigned Professional</h3>
                        <div class="worker-card">
                            <div class="worker-avatar" style="background-image: url('../images/subcategories/electrician.svg');"></div>
                            <div class="worker-details">
                                <h4>John Smith</h4>
                                <p>Electrician • 4.9 ★</p>
                                <p>8 years of experience</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="confirmation-actions">
                        <button class="btn-primary" onclick="window.location.href='customer-dashboard.html'">View Dashboard</button>
                        <button class="btn-secondary" onclick="window.location.href='book-service.html'">Book Another Service</button>
                    </div>
                </div>
                
                <div class="next-steps">
                    <h3>What Happens Next?</h3>
                    <div class="steps">
                        <div class="step">
                            <div class="step-icon" style="background-image: url('../images/subcategories/electrician.svg');"></div>
                            <div class="step-content">
                                <h4>Confirmation</h4>
                                <p>You'll receive a confirmation call from our professional within 30 minutes.</p>
                            </div>
                        </div>
                        
                        <div class="step">
                            <div class="step-icon" style="background-image: url('../images/subcategories/house-cleaning.svg');"></div>
                            <div class="step-content">
                                <h4>Preparation</h4>
                                <p>Prepare your space for the service. Our professional will bring all necessary tools.</p>
                            </div>
                        </div>
                        
                        <div class="step">
                            <div class="step-icon" style="background-image: url('../images/subcategories/watchman.svg');"></div>
                            <div class="step-content">
                                <h4>Service Completion</h4>
                                <p>After service completion, you can rate and review your experience.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 WorkBuddy. All rights reserved.</p>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Simulate worker assignment after a delay
        setTimeout(function() {
            document.querySelector('.processing-steps .step.active').classList.remove('active');
            document.querySelector('.processing-steps .step.completed + .step').classList.add('active');
            
            document.querySelector('.status-card').innerHTML = `
                <div class="status-icon success">✅</div>
                <h2>Worker Assigned Successfully!</h2>
                <p>We've found the perfect professional for your service request.</p>
            `;
            
            document.getElementById('notificationSection').style.display = 'block';
            
            // Show worker card after a short delay
            setTimeout(function() {
                document.querySelector('.processing-steps .step.active').classList.remove('active');
                document.querySelector('.processing-steps .step.completed + .step').classList.add('completed');
                document.querySelector('.processing-steps .step.completed + .step + .step').classList.add('active');
                
                document.getElementById('workerCard').classList.add('active');
                
                // Add notification about active status
                const notification = document.getElementById('notificationSection');
                notification.innerHTML += '<p style="margin-top: 1rem;"><em>Note: This worker is currently marked as <strong>Active</strong> and available for work.</em></p>';
            }, 2000);
        }, 3000);
        
        // Accept button - show payment options
        document.getElementById('acceptButton').addEventListener('click', function() {
            document.querySelector('.processing-steps .step.active').classList.remove('active');
            document.querySelector('.processing-steps .step.completed + .step + .step').classList.add('completed');
            document.querySelector('.processing-steps .step.completed + .step + .step + .step').classList.add('active');
            
            document.getElementById('workerCard').classList.remove('active');
            document.getElementById('paymentOptions').classList.add('active');
        });
        
        // Reject button
        document.getElementById('rejectButton').addEventListener('click', function() {
            alert('Worker rejected. We will assign another professional to your request. Only active workers will be considered for reassignment.');
            // In a real app, this would trigger the algorithm to find another worker
            document.getElementById('workerCard').classList.remove('active');
            document.querySelector('.status-card').innerHTML = `
                <div class="status-icon processing">⏳</div>
                <h2>Finding Another Professional</h2>
                <p>Looking for another suitable worker for your service request.</p>
                <p style="margin-top: 1rem;"><em>Only workers marked as "Active" will be assigned to your request.</em></p>
            `;
            
            // Simulate finding another worker
            setTimeout(function() {
                document.querySelector('.status-card').innerHTML = `
                    <div class="status-icon success">✅</div>
                    <h2>New Worker Assigned!</h2>
                    <p>We've found another professional for your service request.</p>
                    <p style="margin-top: 1rem;"><em>Note: This worker is currently marked as <strong>Active</strong> and available for work.</em></p>
                `;
                // In a real implementation, this would show a different worker
                document.getElementById('workerCard').classList.add('active');
            }, 3000);
        });
        
        // Negotiate button
        document.getElementById('negotiateButton').addEventListener('click', function() {
            document.getElementById('chatContainer').classList.add('active');
        });
        
        // Send message in chat
        document.getElementById('sendButton').addEventListener('click', function() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (message) {
                const chatMessages = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message customer-message';
                messageDiv.innerHTML = `<div class="message-bubble customer-bubble">${message}</div>`;
                chatMessages.appendChild(messageDiv);
                
                // Clear input
                messageInput.value = '';
                
                // Scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        });
        
        // Propose specific price
        document.getElementById('proposePriceButton').addEventListener('click', function() {
            const priceInput = document.getElementById('priceInput');
            const proposedPrice = priceInput.value.trim();
            
            if (proposedPrice && !isNaN(proposedPrice) && proposedPrice > 0) {
                const chatMessages = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message customer-message';
                messageDiv.innerHTML = `<div class="message-bubble customer-bubble">I would like to propose a price of ₹${proposedPrice} for this service.</div>`;
                chatMessages.appendChild(messageDiv);
                
                // Show the price slider for adjustment
                document.getElementById('priceSliderContainer').style.display = 'block';
                
                // Set slider values based on proposed price
                const slider = document.getElementById('priceSlider');
                const minPrice = Math.max(800, proposedPrice * 0.8);
                const maxPrice = proposedPrice * 1.2;
                
                slider.min = minPrice;
                slider.max = maxPrice;
                slider.value = proposedPrice;
                
                document.getElementById('minPrice').textContent = `₹${Math.round(minPrice)}`;
                document.getElementById('maxPrice').textContent = `₹${Math.round(maxPrice)}`;
                document.getElementById('selectedPrice').textContent = `₹${proposedPrice}`;
                
                // Simulate worker response after a delay
                setTimeout(function() {
                    const workerResponse = document.createElement('div');
                    workerResponse.className = 'message worker-message';
                    workerResponse.innerHTML = `<div class="message-bubble worker-bubble">Thank you for your proposal of ₹${proposedPrice}. I need to consider this offer.</div>`;
                    chatMessages.appendChild(workerResponse);
                    
                    // Show worker response section
                    document.getElementById('workerResponseSection').style.display = 'block';
                    document.getElementById('workerResponseMessage').innerHTML = `<p>Rajesh is considering your offer of ₹${proposedPrice}. Please wait for his response or continue negotiating.</p>`;
                    
                    // Scroll to bottom
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }, 1500);
                
                // Clear input
                priceInput.value = '';
                
                // Scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } else {
                alert('Please enter a valid price amount.');
            }
        });
        
        // Update selected price as slider moves
        document.getElementById('priceSlider').addEventListener('input', function() {
            const selectedPrice = this.value;
            document.getElementById('selectedPrice').textContent = `₹${selectedPrice}`;
        });
        
        // Use slider price
        document.getElementById('useSliderPriceButton').addEventListener('click', function() {
            const selectedPrice = document.getElementById('priceSlider').value;
            
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message customer-message';
            messageDiv.innerHTML = `<div class="message-bubble customer-bubble">I would like to adjust my proposal to ₹${selectedPrice}.</div>`;
            chatMessages.appendChild(messageDiv);
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Simulate worker response after a delay
            setTimeout(function() {
                const workerResponse = document.createElement('div');
                workerResponse.className = 'message worker-message';
                workerResponse.innerHTML = `<div class="message-bubble worker-bubble">Thank you for your adjusted proposal of ₹${selectedPrice}. I'm considering this offer.</div>`;
                chatMessages.appendChild(workerResponse);
                
                // Scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 1500);
        });
        
        // Accept worker's price
        document.getElementById('acceptWorkerPrice').addEventListener('click', function() {
            const chatMessages = document.getElementById('chatMessages');
            const workerResponse = document.createElement('div');
            workerResponse.className = 'message customer-message';
            workerResponse.innerHTML = `<div class="message-bubble customer-bubble">I accept your counter offer. Let's proceed with this price.</div>`;
            chatMessages.appendChild(workerResponse);
            
            // Hide worker response section
            document.getElementById('workerResponseSection').style.display = 'none';
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            alert('You have accepted the worker\'s price. You can now confirm the final price to proceed with payment.');
        });
        
        // Reject worker's price
        document.getElementById('rejectWorkerPrice').addEventListener('click', function() {
            const chatMessages = document.getElementById('chatMessages');
            const workerResponse = document.createElement('div');
            workerResponse.className = 'message customer-message';
            workerResponse.innerHTML = `<div class="message-bubble customer-bubble">I'm not able to accept that price. Let's continue discussing.</div>`;
            chatMessages.appendChild(workerResponse);
            
            // Hide worker response section
            document.getElementById('workerResponseSection').style.display = 'none';
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        });
        
        // Confirm price button - show payment options
        document.getElementById('confirmPriceButton').addEventListener('click', function() {
            // Check if there's a proposed price in the chat
            const chatMessages = document.getElementById('chatMessages');
            const customerMessages = chatMessages.querySelectorAll('.customer-message');
            let lastPrice = null;
            
            // Find the last proposed price
            for (let i = customerMessages.length - 1; i >= 0; i--) {
                const messageText = customerMessages[i].textContent;
                const priceMatch = messageText.match(/₹(\d+)/);
                if (priceMatch) {
                    lastPrice = priceMatch[1];
                    break;
                }
            }
            
            // Show confirmation based on whether a price was proposed
            if (lastPrice) {
                if (confirm(`Are you sure you want to confirm the negotiated price of ₹${lastPrice}? The worker will be notified of your acceptance.`)) {
                    // Simulate worker agreement
                    const workerAgreement = document.createElement('div');
                    workerAgreement.className = 'message worker-message';
                    workerAgreement.innerHTML = `<div class="message-bubble worker-bubble">I agree to the price of ₹${lastPrice}. The booking is confirmed!</div>`;
                    chatMessages.appendChild(workerAgreement);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    
                    // Proceed to payment after a short delay
                    setTimeout(function() {
                        document.querySelector('.processing-steps .step.active').classList.remove('active');
                        document.querySelector('.processing-steps .step.completed + .step + .step').classList.add('completed');
                        document.querySelector('.processing-steps .step.completed + .step + .step + .step').classList.add('active');
                        
                        document.getElementById('chatContainer').classList.remove('active');
                        document.getElementById('paymentOptions').classList.add('active');
                    }, 2000);
                }
            } else {
                // No specific price proposed, proceed with original flow
                document.querySelector('.processing-steps .step.active').classList.remove('active');
                document.querySelector('.processing-steps .step.completed + .step + .step').classList.add('completed');
                document.querySelector('.processing-steps .step.completed + .step + .step + .step').classList.add('active');
                
                document.getElementById('chatContainer').classList.remove('active');
                document.getElementById('paymentOptions').classList.add('active');
            }
        });
        
        // Cancel negotiation button
        document.getElementById('cancelNegotiationButton').addEventListener('click', function() {
            if (confirm('Are you sure you want to cancel the negotiation?')) {
                document.getElementById('chatContainer').classList.remove('active');
            }
        });
        
        // Allow sending message with Enter key
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('sendButton').click();
            }
        });
        
        // Allow proposing price with Enter key
        document.getElementById('priceInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('proposePriceButton').click();
            }
        });
        
        // Payment method selection
        const paymentMethods = document.querySelectorAll('.payment-method');
        paymentMethods.forEach(method => {
            method.addEventListener('click', function() {
                paymentMethods.forEach(m => m.classList.remove('selected'));
                this.classList.add('selected');
            });
        });
        
        // Proceed to payment
        document.getElementById('proceedToPayment').addEventListener('click', function() {
            const selectedMethod = document.querySelector('.payment-method.selected');
            if (selectedMethod) {
                // Get booking ID from URL or element
                const urlParams = new URLSearchParams(window.location.search);
                const bookingId = urlParams.get('id') || 1; // Default to 1 if not found
                
                // Get the payment method text
                const paymentMethodText = selectedMethod.querySelector('div:last-child').textContent;
                let paymentMethod = 'UPI'; // Default
                
                // Map the text to our payment method enum
                if (paymentMethodText.includes('UPI')) {
                    paymentMethod = 'UPI';
                } else if (paymentMethodText.includes('Escrow') || paymentMethodText.includes('Wallet')) {
                    paymentMethod = 'ESCROW_WALLET';
                } else if (paymentMethodText.includes('Credit')) {
                    paymentMethod = 'CREDIT_CARD';
                }
                
                // Get the final price (in a real app, this would come from the booking)
                const finalPrice = 1500; // Default price for demo
                
                // If Razorpay is selected, initiate Razorpay payment
                if (paymentMethod === 'CREDIT_CARD') {
                    initiateRazorpayPayment(bookingId, finalPrice);
                } else {
                    // For other payment methods, use the existing flow
                    processStandardPayment(bookingId, finalPrice, paymentMethod);
                }
            } else {
                alert('Please select a payment method.');
            }
        });
        
        // Function to process standard payments (non-Razorpay)
        function processStandardPayment(bookingId, amount, paymentMethod) {
            // Disable the button and show processing message
            const payButton = document.getElementById('proceedToPayment');
            const originalText = payButton.textContent;
            payButton.textContent = 'Processing...';
            payButton.disabled = true;
            
            // Make API call to process payment
            fetch(`http://localhost:8080/api/payments/process/${bookingId}?amount=${amount}&paymentMethod=${paymentMethod}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // On success, redirect to booking success page
                alert(`Payment successful! Transaction ID: ${data.transactionId}`);
                window.location.href = `booking-success.html?id=${bookingId}&txn=${data.transactionId}`;
            })
            .catch(error => {
                console.error('Payment error:', error);
                alert('Payment failed. Please try again.');
                payButton.textContent = originalText;
                payButton.disabled = false;
            });
        }
        
        // Function to initiate Razorpay payment
        function initiateRazorpayPayment(bookingId, amount) {
            // Disable the button and show processing message
            const payButton = document.getElementById('proceedToPayment');
            const originalText = payButton.textContent;
            payButton.textContent = 'Processing...';
            payButton.disabled = true;
            
            // Create order request
            const orderData = {
                amount: amount,
                currency: 'INR',
                receipt: `receipt_${bookingId}_${Date.now()}`,
                bookingId: bookingId,
                customerName: 'John Doe', // In a real app, this would come from user data
                customerEmail: 'john.doe@example.com', // In a real app, this would come from user data
                customerPhone: '9876543210' // In a real app, this would come from user data
            };
            
            // Make API call to create Razorpay order
            fetch('http://localhost:8080/api/razorpay/create-order', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(orderData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Load Razorpay SDK
                    const script = document.createElement('script');
                    script.src = 'https://checkout.razorpay.com/v1/checkout.js';
                    script.onload = function() {
                        // Initialize Razorpay
                        const options = {
                            key: 'rzp_test_your_key_here', // Replace with your Razorpay key
                            amount: data.amount,
                            currency: data.currency,
                            name: 'WorkBuddy',
                            description: 'Service Payment',
                            order_id: data.orderId,
                            handler: function (response) {
                                // Verify payment
                                verifyRazorpayPayment(response, bookingId);
                            },
                            prefill: {
                                name: orderData.customerName,
                                email: orderData.customerEmail,
                                contact: orderData.customerPhone
                            },
                            theme: {
                                color: '#3498db'
                            }
                        };
                        
                        const rzp = new Razorpay(options);
                        rzp.open();
                    };
                    document.body.appendChild(script);
                } else {
                    throw new Error(data.error || 'Failed to create order');
                }
            })
            .catch(error => {
                console.error('Payment error:', error);
                alert('Payment failed. Please try again.');
                payButton.textContent = originalText;
                payButton.disabled = false;
            });
        }
        
        // Function to verify Razorpay payment
        function verifyRazorpayPayment(response, bookingId) {
            const verificationData = {
                razorpayPaymentId: response.razorpay_payment_id,
                razorpayOrderId: response.razorpay_order_id,
                razorpaySignature: response.razorpay_signature,
                bookingId: bookingId
            };
            
            // Make API call to verify payment
            fetch('http://localhost:8080/api/razorpay/verify-payment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(verificationData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Payment successful, redirect to success page
                    alert('Payment successful!');
                    window.location.href = `booking-success.html?id=${bookingId}&txn=${response.razorpay_payment_id}`;
                } else {
                    alert('Payment verification failed. Please contact support.');
                }
            })
            .catch(error => {
                console.error('Verification error:', error);
                alert('Payment verification failed. Please contact support.');
            });
        }
        
        // Back to worker card
        document.getElementById('backToWorker').addEventListener('click', function() {
            document.querySelector('.processing-steps .step.active').classList.remove('active');
            document.querySelector('.processing-steps .step.completed + .step + .step').classList.add('active');
            document.querySelector('.processing-steps .step.completed + .step + .step + .step').classList.remove('active');
            
            document.getElementById('paymentOptions').classList.remove('active');
            document.getElementById('workerCard').classList.add('active');
        });
    </script>
</body>
</html>
